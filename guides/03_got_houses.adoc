= Game of Thrones: Houses
:csv-url: https://raw.githubusercontent.com/mneedham/neo4j-got/master/data/import/
:icons: font

== Importing houses

As well as importing data from CSV files we can also use `LOAD CSV` to explore those same files.

Run the following query to see how many characters there are:

[source, cypher,subs=attributes]
----
LOAD CSV WITH HEADERS FROM "{csv-url}houses.csv" AS row
MERGE (house:House {id: row.link})
ON CREATE SET house.name = row.name
----

[source, cypher]
----
MATCH (house:House)
RETURN house
----

[source, cypher, subs = attributes]
----
LOAD CSV WITH HEADERS FROM "{csv-url}allegiances.csv" AS row
RETURN row
ORDER BY rand()
LIMIT 10
----

If you run this query a few times you'll see that it includes lots of allegiances, not just ones between characters and houses.
Are we gonna import those as well?

For now we're going to filter those rows to only find allegiances between characters and houses.
<This sentence is repetitive with the one two lines before, fix it>

[source, cypher, subs = attributes]
----
LOAD CSV WITH HEADERS FROM "{csv-url}allegiances.csv" AS row
MATCH (character:Character {id: row.character})
MATCH (house:House {id: row.houseLink})
RETURN character, house, row.houseName
----

These are the current allegiances:

[source, cypher, subs = attributes]
----
LOAD CSV WITH HEADERS FROM "{csv-file}allegiances.csv" AS row
WITH row WHERE (NOT tolower(row.houseName) CONTAINS "former") AND (NOT tolower(row.houseName) CONTAINS "until")
MATCH (character:Character {id: row.character})
MATCH (house:House {id: row.houseLink})
RETURN character, house, row.houseName
----

Let's create previous allegiances as well:

[source, cypher, subs = attributes]
----
LOAD CSV WITH HEADERS FROM "{csv-file}allegiances.csv" AS row
WITH row WHERE tolower(row.houseName) CONTAINS "former" OR tolower(row.houseName) CONTAINS "until"
MATCH (character:Character {id: row.character})
MATCH (house:House {id: row.houseLink})
MERGE (character)-[:PREVIOUSLY_HAD_ALLEGIANCE_TO]->(house)
----
